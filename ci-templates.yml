.vault-config: &vault-config
  before_script:
    - apk add --no-cache curl 
    - echo "Checking Vault server connectivity at $VAULT_SERVER_URL"
    - curl -s $VAULT_SERVER_URL/v1/sys/health || (echo "Vault server is not reachable at $VAULT_SERVER_URL" && exit 1)

    - echo "Authenticating with Vault..."
    - vault login -method=jwt role=$VAULT_AUTH_ROLE jwt=$CI_JOB_JWT || (echo "Vault authentication failed" && exit 1)

    - echo "Fetching secrets from Vault..."
    - export DOCKER_USERNAME="$(vault kv get -field=DOCKER_USERNAME secret/pitstopsecrets || exit 1)"
    - export DOCKER_HUB_PASSWORD="$(vault kv get -field=DOCKER_HUB_PASSWORD secret/pitstopsecrets || exit 1)"
    - export GITHUB_TOKEN="$(vault kv get -field=GITHUB_TOKEN secret/pitstopsecrets || exit 1)"
    - export GITLAB_TOKEN="$(vault kv get -field=GITLAB_TOKEN secret/pitstopsecrets || exit 1)"



.build-template:
  image: hashicorp/vault:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    VAULT_SERVER_URL: "http://172.20.0.2:8200" # Updated Vault server URL
    VAULT_AUTH_ROLE: "myproject-staging-123" # Example role name
  <<: *vault-config
  stage: build
  script:
    - cd ${SERVICE_PATH}
    - docker build -t ${DOCKER_IMAGE}:$CI_COMMIT_SHORT_SHA .
    - cd ..
    - mkdir -p images
    - docker save ${DOCKER_IMAGE}:$CI_COMMIT_SHORT_SHA > images/image.tar
  artifacts:
    paths:
      - images/image.tar
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never

.push-template:
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    VAULT_SERVER_URL: "http://172.20.0.2:8200" # Updated Vault server URL
    VAULT_AUTH_ROLE: "myproject-staging-123" # Example role name
  <<: *vault-config
  stage: push
  script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "${DOCKER_USERNAME}" --password-stdin
    - docker load < images/image.tar
    - docker push ${DOCKER_IMAGE}:$CI_COMMIT_SHORT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        docker tag ${DOCKER_IMAGE}:$CI_COMMIT_SHORT_SHA ${DOCKER_IMAGE}:latest
        docker push ${DOCKER_IMAGE}:latest
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

.deploy-template:
  stage: deploy
  image: alpine:latest
  variables:
    GIT_STRATEGY: clone
    VAULT_SERVER_URL: "http://172.20.0.2:8200" # Updated Vault server URL
    VAULT_AUTH_ROLE: "myproject-staging-123" # Example role name
  <<: *vault-config
  before_script:
    - apk add --no-cache git curl
    - curl -sSL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
    - chmod +x /usr/local/bin/yq
    - git config --global user.email "gitlab-ci@example.com"
    - git config --global user.name "GitLab CI"
  script:
    - git clone "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
    - cd ${GITHUB_REPO_NAME}/k8s
    - yq e -i 'select(.kind == "Deployment").spec.template.spec.containers[] |= select(.name == "'${SERVICE_NAME}'").image = "'${DOCKER_IMAGE}':'$CI_COMMIT_SHORT_SHA'"' ${SERVICE_NAME}-depl.yaml
    - git add .
    - git commit -m "Update image tag to $CI_COMMIT_SHORT_SHA [skip ci]"
    - git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git" HEAD:main
    - cd ..
    - git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${GITLAB_REPO}.git"
    - git fetch gitlab main
    - git merge gitlab/main --no-edit
    - git push gitlab main
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
